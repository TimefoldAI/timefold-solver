# TODO release XSD to timefold.ai/xsd/
# TODO tag github issues with version
name: Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
      nextVersion:
        description: 'Next version after release (-SNAPSHOT will be added automatically)'
        required: true
      nextMicroVersion:
        description: 'Next micro version after release (-SNAPSHOT will be added automatically)'
        required: true
      sourceBranch:
        description: 'Branch to use for the release'
        default: main
        required: true
      releaseBranch:
        description: 'Release branch to create (e.g. 1.0.x for version 1.0.0)'
        required: true
      dryRun:
        description: 'Do a dry run? (true or false)'
        default: true
        required: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout timefold-solver
        uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Create release branch and switch to it
        run: |
          git config --local user.email "${{ github.event.pusher.email }}"
          git config --local user.name "${{ github.event.pusher.name }}"
          git checkout -b ${{ github.event.inputs.releaseBranch }}

      - name: Set release version
        run: |
          mvn --no-transfer-progress --batch-mode -Dfull versions:set -DnewVersion=${{ github.event.inputs.version }}
          git add -A && git commit -m "Release version ${{ github.event.inputs.version }}"

      - name: Build release
        run: mvn --no-transfer-progress --batch-mode -Dfull clean deploy -DaltDeploymentRepository=local::default::file://`pwd`/target/staging-deploy

      - name: Update antora.yml
        run: |
          cp docs/target/antora-template.yml docs/src/antora.yml

      - name: Run JReleaser
        run: mvn --no-transfer-progress --batch-mode -Dfull -Djreleaser.dry.run=${{ github.event.inputs.dryRun }} -pl . jreleaser:full-release
        env:
          JRELEASER_GITHUB_TOKEN: ${{ secrets.JRELEASER_GITHUB_TOKEN }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.JRELEASER_GPG_PASSPHRASE }}
          JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.JRELEASER_GPG_PUBLIC_KEY }}
          JRELEASER_GPG_SECRET_KEY: ${{ secrets.JRELEASER_GPG_SECRET_KEY }}
          JRELEASER_NEXUS2_MAVEN_CENTRAL_USERNAME: ${{ secrets.JRELEASER_NEXUS2_MAVEN_CENTRAL_USERNAME }}
          JRELEASER_NEXUS2_MAVEN_CENTRAL_PASSWORD: ${{ secrets.JRELEASER_NEXUS2_MAVEN_CENTRAL_PASSWORD }}

      - name: JReleaser release output
        uses: actions/upload-artifact@v3
        with:
          name: jreleaser-release
          path: |
            timefold-solver/target/jreleaser/trace.log
            timefold-solver/target/jreleaser/output.properties

      - name: Set micro snapshot version
        run: |
          mvn --no-transfer-progress --batch-mode -Dfull versions:set -DnewVersion=${{ github.event.inputs.nextMicroVersion }}-SNAPSHOT
          git add -A && git commit -m "Move to ${{ github.event.inputs.nextMicroVersion }}-SNAPSHOT"

      - name: Switch back to source branch and set snapshot version
        run: |
          git checkout ${{ github.event.inputs.sourceBranch }}
          mvn --no-transfer-progress --batch-mode -Dfull versions:set -DnewVersion=${{ github.event.inputs.nextVersion }}-SNAPSHOT
          git add -A && git commit -m "Move to ${{ github.event.inputs.nextVersion }}-SNAPSHOT"

      - name: Push everything to Git
        run: |
          git push origin --all
